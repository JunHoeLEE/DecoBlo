<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.decoblog.www.blog.dao.BlogMapper">

<resultMap id="selectMap" type="java.util.HashMap">
	<id column="menuParent" property="menuParent"/>
	<collection property="Menu" javaType="java.util.ArrayList" resultMap="menus" />
</resultMap>

<resultMap type="Menu" id="menus">
	<result property="menuNo" column="menuNo"/>
	<result property="menuName" column="menuName"/>
	<result property="menuParent" column="menuParent"/>
	<result property="menuDepth" column="menuDepth"/>
	<result property="menuSeq" column="menuSeq"/>
	<result property="menuVisible" column="menuVisible"/>
	<result property="menuLink" column="menuLink"/>
	<result property="menuParentSeq" column="menuParentSeq"/>
</resultMap>

<!-- 메뉴 가져오기 -->
<select id="selectMenu" parameterType="int" resultMap="selectMap">
	SELECT 
		*
	FROM
		db_menu
	WHERE
		menuUserNo = #{menuUserNo}
	ORDER BY 
		menuparentseq, menuseq
	
</select>
<!-- 블록 넘버 가져오기 -->
<select id="selectThumnail" parameterType="string" resultType="int">
	SELECT blocktmpno FROM DB_BLOCK_TEMPLATE WHERE blocktmptype=#{tmpType}
</select>

<update id="updateMenuTitle" parameterType="Menu">
	UPDATE 
		db_menu
	SET
		menuName = #{menuName}
	WHERE
		menuNo = #{menuNo}
</update>
<update id="updateSmallMenuPush" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuSeq = menuSeq + 1
	WHERE
		menuSeq >= #{newMenuSeq}
	AND 
		menuParent = #{newMenuParent}
	AND
		menuUserNo = #{menuUserNo}
</update>
<update id="updateSmallMenuPull" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuSeq = menuSeq - 1
	WHERE
		menuSeq > #{menuSeq}
	AND 
		menuParent = #{menuParent}
	AND
		menuUserNo = #{menuUserNo}
</update>

<update id="updateLargeMenuPush" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuParentSeq = menuParentSeq + 1
	WHERE
		menuParentSeq > #{menuParentSeq}
	AND
		menuUserNo = #{menuUserNo}
		
</update>
<update id="updateLargeMenuPull" parameterType="map">
	UPDATE 
		db_menu
	SET
		menuParentSeq = menuParentSeq - 1
	WHERE
		menuParentSeq > #{menuParentSeq}
	AND
		menuUserNo = #{menuUserNo}
</update>

<update id="updateMenu" parameterType="map">
	UPDATE 
		db_menu
	SET
		<if test="newMenuDepth==0">
			menuSeq = 0,
			menuParent = #{menuNo},
			menuParentSeq = #{newMenuSeq},
		</if>
		<if test="newMenuDepth!=0">
			menuSeq = #{newMenuSeq},
			menuParent = #{newMenuParent},
			menuParentSeq = (SELECT menuParentSeq FROM db_menu WHERE menuNo=#{newMenuParent}),
		</if>
		menuDepth = #{newMenuDepth}
	WHERE
		menuNo = #{menuNo}
</update>
<!-- 블로그 타이틀 수정 -->
<update id="updateBlogTitle" parameterType="map">
	UPDATE 
		db_user
	SET
		blogTitle = #{blogTitle}
	WHERE
		userNo = #{userNo}
</update>
<!-- 블로그 메타태그 수정 -->
<update id="updateMetaTag" parameterType="map">
	UPDATE 
		db_user
	SET
		metaAuthor = #{metaAuthor},
		metaKeyword = #{metaKeyword},
		metaDescription = #{metaDescription}
	WHERE
		userNo = #{userNo}
</update>
<!-- 블로그 메타태그 수정 -->
<update id="updateBackgroundColor" parameterType="map">
	UPDATE 
		db_user
	SET
		configBackgroundColor = #{configBackgroundColor}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateBlogFont" parameterType="map">
	UPDATE 
		db_user
	SET
		configBasicFont = #{configBasicFont}
	WHERE
		userNo = #{userNo}
</update>
<update id="updateOnepageStyle" parameterType="map">
	UPDATE 
		db_user
	SET
		configOnepageStyle = #{configOnepageStyle}
	WHERE
		userNo = #{userNo}
</update>
<!-- 사이트설정 가져오기 -->
<select id="selectBlog" resultType="User" parameterType="int">
	SELECT 
		*
	FROM
		db_user
	WHERE
		userNo = #{userNo}
</select>

<!-- 블록 코드 가져오기 -->
<!-- 블록 코드 가져오기 썸네일 -->
<select id="selectBlockContent" parameterType="int" resultType="string">
SELECT UTL_RAW.CAST_TO_VARCHAR2(DBMS_LOB.SUBSTR(blocktmpcontent)) AS blockTmpContent FROM db_block_template
 WHERE blocktmpno =#{blocktmpNo}
 </select>
 
 <!-- 블록 가져오기 메뉴 -->
 <select id="selectBlockList" parameterType="Menu" resultType="Block">
 SELECT blockno,blockmenuno,UTL_RAW.CAST_TO_VARCHAR2(DBMS_LOB.SUBSTR(blockcontent)) as blockContent,blockseq
FROM db_block,db_menu,db_user
WHERE db_block.blockmenuno=db_menu.menuno AND db_menu.menuno=#{menuNo}
AND db_menu.menuuserno = db_user.userno AND db_user.userno=#{menuUserNo}
ORDER BY blockseq
 </select> 
 
 <!-- 블록 입력 -->
<insert id="insertBlock" parameterType="Block">
INSERT INTO db_block VALUES(
db_block_seq.nextval,1,#{blockTmpNo},#{blockSeq},
UTL_RAW.CAST_TO_RAW(#{blockContent}),344)
</insert>
<!-- 블록 Seq 한자리씩 미루기 -->
<update id="updateBlockSeq" parameterType="int">
UPDATE db_block SET blockseq = blockseq+1 WHERE blockseq >=#{blockSeq}
</update>
<!-- 블럭 삭제 -->
<delete id="deleteBlock" parameterType="int">
DELETE db_block WHERE blockseq=#{blockSeq}
</delete>
</mapper>