<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.decoblog.www.board.dao.BoardMapper">

<!-- 글 목록 --> 
<select id="select" parameterType="map" resultType="Bbs">
	SELECT
		bbsNo
		, boardNo
		, bbsTitle
		, bbsContent 
		, bbsCount
		, bbsLike
		, bbsParent
		, bbsDepth
		, bbsSeq
		, to_char(bbsRegdate, 'YYYY-MM-DD') bbsRegdate
		, to_char(bbsEditDate, 'YYYY-MM-DD') bbsEditDate
	FROM
		db_bbs
	WHERE
		${searchItem} like '%' || #{searchWord} || '%'
	ORDER BY
		bbsParent desc, bbsDepth asc, bbsSeq desc
</select>

<!-- 글 상세보기 -->
<select id="selectOneBbs" parameterType="int" resultType="Bbs">
	SELECT
		bbsNo
		, boardNo
		, bbsTitle
		, bbsContent
		, bbsCount
		, (select count(*) from db_like where bbsNo= #{bbsNo}) as bbsLike 
		, bbsParent
		, bbsDepth
		, bbsSeq
		, to_char(bbsRegdate, 'YYYY-MM-DD') bbsRegdate
		, to_char(bbsEditDate, 'YYYY-MM-DD') bbsEditDate
	FROM 
		db_bbs
	WHERE
		bbsNo = #{bbsNo}
	ORDER BY
		bbsRegdate desc
</select>

<!-- 첨부파일 상세보기 -->
<select id="selectOneBbsAttach" parameterType="int" resultType="BbsAttach">
	SELECT
		attachNo
		, attachBbsNo 
		, attachOriginalFile 
		, attachSavedFile 
	FROM
		db_bbs_attach
	WHERE
		attachBbsNo = #{attachBbsNo}
	ORDER BY
		attachNo desc
</select>

<!-- 글 쓰기 -->
<insert id="insertBbs" parameterType="Bbs">
	INSERT INTO db_bbs (
		bbsNo
		, boardNo
		, bbsTitle
		, bbsContent
        , bbsCount
		, bbsLike
		, bbsParent
		, bbsDepth
		, bbsSeq
		, bbsRegdate
		, bbsreguser
	) VALUES (
		db_bbs_seq.NEXTVAL
		, #{boardNo}
		, #{bbsTitle}
		, #{bbsContent}
        , 0
		, 0
		<choose>
			<when test="bbsParent==0">
				, db_bbs_seq.NEXTVAL
				, 0
				, 0
			</when>
			<otherwise>
				, #{bbsParent}
				, 1
				, (SELECT MAX(bbsSeq)+1 FROM db_bbs WHERE bbsParent = #{bbsParent}) 
			</otherwise>
		</choose>
		, SYSDATE
		, #{bbsreguser}
	)
</insert>


<!-- 첨부파일 넣기 -->
<insert id="insertAttach" parameterType="BbsAttach">
	INSERT INTO db_bbs_attach (
		attachNo
		, attachBbsNo
		, attachOriginalFile
		, attachSavedFile
	) VALUES (
		db_bbs_attach_seq.NEXTVAL
		, #{attachBbsNo}
		, #{attachOriginalFile}
		, #{attachSavedFile}
	)
</insert>


<!-- 글 수정 -->
<update id="updateBbs" parameterType="Bbs">
	UPDATE 
		db_bbs 
	SET
		bbsTitle  = #{bbsTitle}
		, bbsContent = #{bbsContent}
		, bbsEditDate = sysdate
	WHERE
		bbsNo = #{bbsNo}
</update>


<!-- 첨부파일 수정 -->
<update id="updateBbsAttach" parameterType="BbsAttach">
	UPDATE 
		db_bbs_attach 
	SET
		attachNo = db_bbs_attach_seq.NEXTVAL
		, attachOriginalFile = #{attachOriginalFile}
		, attachSavedFile = #{attachSavedFile}
	WHERE
		attachBbsNo = #{attachBbsNo}
</update>



<!-- 글 삭제 -->
<delete id="deleteBbs" parameterType="int">
	DELETE FROM 
		db_bbs
	WHERE
		bbsNo = #{bbsNo}
</delete>

<!-- 첨부파일 삭제 -->
<delete id="deleteBbsAttach" parameterType="BbsAttach">
	DELETE FROM 
		db_bbs_attach
	WHERE
		attachBbsNo = #{attachBbsNo}
</delete>

<!-- 전체 글 개수 조회 -->
<select id="getTotalBbs" parameterType="map" resultType="int">
	SELECT
		count(*)
	FROM
		db_bbs
	WHERE
		${searchItem} like '%' || #{searchWord} || '%'
</select>

<!-- 조회수 +1 -->
<update id="updateBbsCount" parameterType="int">
	UPDATE 
		db_bbs
	SET
		bbsCount = bbsCount+1
	WHERE
		bbsNo = #{bbsNo}
</update>



<!-- 좋아요 -->
<select id="selectOneLike" parameterType="int" resultType="Like">
	SELECT 
		likeNo
		, likeUserNo
		, likeBbsNo
	FROM
		db_like
	WHERE
		likeUserNo = #{likeUserNo}
	AND
		likeBbsNo = #{likeBbsNo}
</select>

<insert id="insertLike" parameterType="Like">
	INSERT INTO db_like
	VALUES(
		db_like_seq.nextval
		, #{likeUserNo}
		, #{likeBbsNo}
	)

</insert>

<delete id="deleteLike" parameterType="int">
	DELETE FROM db_like
	WHERE
		likeUserNo = #{likeUserNo}
	AND
		likeBbsNo = #{likeBbsNo}
</delete>

<!-- 댓글 -->

<!-- 댓글 목록 -->
<select id="selectReply" resultType="Reply" parameterType="int">
	SELECT
		replyNo
		, replyBbsNo
		, replyContent
		, replyParent
		, replyDepth 
		, replySeq 
		, to_char(replyRegDate, 'YYYY-MM-DD') as replyRegDate 
		, replyRegUser
		, to_char(replyEditDate, 'YYYY-MM-DD') as replyEditDate
	FROM
		db_reply
	WHERE
		replyBbsNo = #{replyBbsNo}
	ORDER BY
		replyParent asc, replyDepth asc, replySeq asc
</select>

<!-- 댓글 입력 -->
<insert id="insertReply" parameterType="Reply">
	INSERT INTO db_reply(
		replyNo
		, replyBbsNo
		, replyContent
		, replyParent
		, replyDepth 
		, replySeq 
		, replyRegDate 
		, replyRegUser
	) VALUES(
		db_reply_seq.nextval
		, #{replyBbsNo}
		, #{replyContent}
		<choose>
			<when test="replyParent==0">
				, db_reply_seq.NEXTVAL
				, 0
				, 0
			</when>
			<otherwise>
				, #{replyParent}
				, 1
				, (SELECT MAX(replySeq)+1 FROM db_reply WHERE replyParent = #{replyParent}) 
			</otherwise>
		</choose>
		, SYSDATE
		, #{replyRegUser}
	)
</insert>


<!-- 댓글 삭제 -->
<delete id="deleteReply" parameterType="int">
	DELETE FROM db_reply
	WHERE 
		replyNo = #{replyNo}
</delete>


<!-- 댓글 수정 -->
<update id="updateReply" parameterType="Reply">
	UPDATE db_reply
	SET	
		replyContent = #{replyContent}
		, replyEditDate = SYSDATE
	WHERE
		replyNo = #{replyNo}
</update>

<!-- 유저 NO 받아오기 -->
	<select id="selectuserno" parameterType="int" resultType="int">
	select BBSREGUSER from db_bbs
	WHERE bbsNo = #{bbsNo}
	
	</select>
<!-- 게시판 조회수 증가  데이터 받거나 없으면 생성하기 -->
	<update id="inupStat" parameterType="int" >
	MERGE INTO DB_STAT t1
	USING DUAL 
    ON (t1.statuserno = #{userNo} and trunc(t1.statregdate)=trunc(sysdate))
	WHEN MATCHED THEN
    UPDATE SET statBbsCount = statBbsCount + 1	
	WHEN NOT MATCHED THEN
    INSERT (statno,statuserno, statBbsCount, statregdate)
    VALUES (db_stat_seq.nextval,#{userNo},'1',sysdate)
</update>
	<!--  게시판 삭제시 반영 -->
 	<update id="decreasebbscount" parameterType="int">
 	UPDATE DB_STAT
 	SET
 	statBbsCount = statBbsCount - 1
 	WHERE statuserno = #{userNo} and trunc(statregdate)=trunc(sysdate)
</update>
	<!-- 댓글 게시판번호를 이용해 유저번호 -->
	<select id="selectuserno2" parameterType="int" resultType="int">
	select DISTINCT db_bbs.bbsreguser as bbsreguser from db_reply
	inner join  db_bbs 
	on db_reply.replybbsNO = #{bbsno} and db_bbs.bbsno = db_reply.replybbsNO
</select>
	<!-- 댓글NO를 이용해 유저번호 -->
	<select id="selectuserno3" parameterType="int" resultType="int">
	select DISTINCT db_bbs.bbsreguser as bbsreguser from db_reply
	inner join  db_bbs 
	on db_reply.replyNo = #{replyno} and db_bbs.bbsno = db_reply.replybbsNO
</select>
	<!-- 댓글 증가 stat 반영 -->
	<update id="inputreplycount">
 	UPDATE DB_STAT
 	SET
 	statReplyCount = statReplyCount + 1
 	WHERE statuserno = #{userNo} and trunc(statregdate)=trunc(sysdate)
</update>
	<!-- 댓글 감소 stat 반영 -->
	<update id="decreasereplycount" parameterType="int">
 	UPDATE DB_STAT
 	SET
 	statReplyCount = statReplyCount - 1
 	WHERE statuserno = #{userNo} and trunc(statregdate)=trunc(sysdate)
</update>
 	<!-- 좋아요 감소 stat 반영 -->
 	<update id="decreaselike">
 	UPDATE DB_STAT
 	SET
 	statBBSLike = statBBSLike - 1
 	WHERE statuserno = #{userno} and trunc(statregdate)=trunc(sysdate)
</update>
 	<!-- 좋아요 증가 stat 반영 -->
 	<update id="inputlike">
 	UPDATE DB_STAT
 	SET
 	statBBSLike = statBBSLike + 1
 	WHERE statuserno = #{userno} and trunc(statregdate)=trunc(sysdate)
</update>
	<!-- 좋아요 이용한 유저 정보 획득 -->
	<select id="selectuserno4" parameterType="int" resultType="int">
	select DISTINCT db_bbs.bbsreguser as bbsreguser from db_like
	inner join  db_bbs 
	on  db_bbs.bbsno = #{bbsno}  	
</select>
</mapper>